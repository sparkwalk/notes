# libtool 链接时, 不能链接指定库

**问题:**  在makfile.am中已经指定库路径:

```
ZLIB_CFLAG  = -I$(top_srcdir)/libs/zlib-1.2.11/
ZLIB_LDFLAG = -L$(top_srcdir)/libs/zlib-1.2.11/
ZLIB_LIB   = -lz

transfer_CFLAGS  = $(ZLIB_CFLAG)
transfer_LDFLAGS = $(ZLIB_LDFLAG) -no-install
transfer_LDADD   = $(ZLIB_LIB)
```

可是在make时却链接的是系统库:

```
libtool: link: gcc -I../libs/zlib-1.2.11/ -g -O0 -o transfer transfer-compress.o  -L../libs/zlib-1.2.11/ -lz
```

通过strace 跟踪, 可以更清晰的看到:

```
openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libz.so.1", O_RDONLY|O_CLOEXEC) = 3
```



**解决:** 这是因为libtool链接库时, 首先找到**.la**文件,  再根据la文件中指定的库路径去链接库.

在zlib-1.2.11下手动添加**libz.la** 文件即可.

```
# libz.la - a libtool library file
# Generated by libtool (GNU libtool) 2.4.6
#
# Please DO NOT delete this file!
# It is necessary for linking the library.

# The name that we can dlopen(3).
dlname='libz.so.1'

# Names of this library.
library_names='libz.so.1.2.11 libz.so.1 libz.so'      

# The name of the static archive.
old_library='libz.a'

# Linker flags that cannot go in dependency_libs.
inherited_linker_flags=' -pthread'

# Libraries that this one depends upon.
dependency_libs=''

# Names of additional weak libraries provided by this library
weak_library_names=''

# Version information for libz.
current=1
age=2
revision=11

# Is this an already installed library?
installed=no

# Should we warn about portability when linking against -modules?
shouldnotlink=no

# Files to dlopen/dlpreopen
dlopen=''
dlpreopen=''

# Directory that this library needs to be installed in:
libdir='/usr/local/lib'
```

再次编译:

```
libtool: link: gcc -I../libs/zlib-1.2.11/ -g -O0 -o transfer transfer-compress.o  -L../libs/zlib-1.2.11/ /home/licg/workspace/learn/transfer/libs/zlib-1.2.11/libz.so -pthread -Wl,-rpath -Wl,/home/licg/workspace/learn/transfer/libs/zlib-1.2.11
```

使用strace跟踪, 可以看到已经使用指定的libz库了:

```
openat(AT_FDCWD, "/home/licg/workspace/learn/transfer/libs/zlib-1.2.11/libz.so.1", O_RDONLY|O_CLOEXEC) = 3
```

